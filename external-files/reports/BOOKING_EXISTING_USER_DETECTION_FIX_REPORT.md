# üéØ –û–¢–ß–ï–¢: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—Ä–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏

## üìã –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ —Ñ–æ—Ä–º—É `/client/booking/new-with-availability` –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–ª—É—á–∞–ª–∏ –æ—à–∏–±–∫—É "selected time is unavailable" –¥–∞–∂–µ –∫–æ–≥–¥–∞ –≤—Ä–µ–º—è –±—ã–ª–æ –¥–æ—Å—Ç—É–ø–Ω–æ. –ü—Ä–∏ –¥–µ—Ç–∞–ª—å–Ω–æ–º –∞–Ω–∞–ª–∏–∑–µ –≤—ã—è—Å–Ω–∏–ª–æ—Å—å, —á—Ç–æ –æ—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ –±—ã–ª–∞ –≤ —Ç–æ–º, —á—Ç–æ:

1. **API –≤–æ–∑–≤—Ä–∞—â–∞–ª –æ—à–∏–±–∫—É "wrong number of arguments"** –≤ –º–µ—Ç–æ–¥–µ `check_availability_at_time`
2. **–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è API** –æ–±–Ω–∞—Ä—É–∂–∏–ª–∞—Å—å –ø—Ä–æ–±–ª–µ–º–∞ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
3. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∞–º–∏/email** –ø–æ–ª—É—á–∞–ª–∏ –æ—à–∏–±–∫—É "Email/Phone has already been taken"

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### –ê–Ω–∞–ª–∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
```ruby
# –ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:
User.find(55) # –ê–ª–µ–∫—Å–∞–Ω–¥—Ä –ü–µ—Ç—Ä–µ–Ω–∫–æ, Phone: +380671234567, Client: nil
User.find(50) # –¢–µ—Å—Ç–æ–≤—ã–π –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, Email: test@test.com, Client: nil
```

### –ü—Ä–æ–±–ª–µ–º—ã –≤ –∫–æ–¥–µ
1. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤** –≤ `DynamicAvailabilityService.check_availability_at_time`
2. **–ù–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø–æ–∏—Å–∫–∞** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (OR –≤–º–µ—Å—Ç–æ AND)
3. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–µ–∑ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
4. **–ù–µ–∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ –æ—à–∏–±–∫–∏** –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

## ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### 1. Backend API (tire-service-master-api)

#### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—ã–∑–æ–≤–∞ availability service
```ruby
# app/controllers/api/v1/client_bookings_controller.rb
def perform_availability_check
  booking_data = booking_params
  
  DynamicAvailabilityService.check_availability_at_time(
    booking_data[:service_point_id].to_i,
    Date.parse(booking_data[:booking_date]),
    Time.parse("#{booking_data[:booking_date]} #{booking_data[:start_time]}"),
    calculate_duration_minutes,
    exclude_booking_id: nil,           # ‚Üê –ò–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä
    category_id: booking_data[:service_category_id]  # ‚Üê –ò–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä
  )
end
```

#### –£–ª—É—á—à–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
```ruby
# –ë—ã–ª–æ: –ø–æ–∏—Å–∫ –ø–æ –æ–¥–Ω–æ–º—É –ø–æ–ª—é (OR)
user = if client_data[:phone].present?
  User.find_by(phone: client_data[:phone])
elsif client_data[:email].present?
  User.find_by(email: client_data[:email])
end

# –°—Ç–∞–ª–æ: –ø–æ–∏—Å–∫ –ø–æ –æ–±–æ–∏–º –ø–æ–ª—è–º –æ—Ç–¥–µ–ª—å–Ω–æ
user_by_phone = client_data[:phone].present? ? User.find_by(phone: client_data[:phone]) : nil
user_by_email = client_data[:email].present? ? User.find_by(email: client_data[:email]) : nil
existing_user = user_by_phone || user_by_email
```

#### –ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
```ruby
if existing_user
  conflict_field = user_by_phone ? '—Ç–µ–ª–µ—Ñ–æ–Ω' : 'email'
  render json: { 
    error: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç',
    details: ["–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º #{conflict_field} —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è"],
    existing_user: {
      id: existing_user.id,
      first_name: existing_user.first_name,
      last_name: existing_user.last_name,
      email: existing_user.email,
      phone: existing_user.phone,
      role: existing_user.role.name,
      client_id: existing_user.client&.id
    }
  }, status: :conflict # HTTP 409 –≤–º–µ—Å—Ç–æ 422
  return nil
end
```

### 2. Frontend (tire-service-master-web)

#### –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
```typescript
// src/pages/bookings/NewBookingWithAvailabilityPage.tsx
catch (error: any) {
  // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (—Å—Ç–∞—Ç—É—Å 409), –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥ –≤—Ö–æ–¥–∞
  if (error.status === 409 && error.data?.existing_user) {
    console.log('–ù–∞–π–¥–µ–Ω —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:', error.data.existing_user);
    
    let errorMessage = error.data.error || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç';
    if (error.data.details) {
      errorMessage += '\n' + error.data.details.join('\n');
    }
    errorMessage += '\n\n–í—ã –º–æ–∂–µ—Ç–µ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É, –∏—Å–ø–æ–ª—å–∑—É—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∞–∫–∫–∞—É–Ω—Ç, –∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.';
    
    setSubmitError(errorMessage);
    return;
  }
  
  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥—Ä—É–≥–∏—Ö –æ—à–∏–±–æ–∫...
}
```

## üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

### –¢–µ—Å—Ç 1: –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É
```bash
curl -X POST "http://localhost:8000/api/v1/client_bookings" \
  -H "Content-Type: application/json" \
  -d '{
    "client": {
      "first_name": "–¢–µ—Å—Ç",
      "phone": "+380671234567",
      "email": "test@test.com"
    },
    "booking": { ... },
    "car": { "car_type_id": 1 }
  }'
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```json
{
  "error": "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç",
  "details": ["–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º —Ç–µ–ª–µ—Ñ–æ–Ω —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è"],
  "existing_user": {
    "id": 55,
    "first_name": "–ê–ª–µ–∫—Å–∞–Ω–¥—Ä",
    "last_name": "–ü–µ—Ç—Ä–µ–Ω–∫–æ",
    "email": "petrov@shino-express.ua",
    "phone": "+380671234567",
    "role": "partner",
    "client_id": null
  }
}
```

### –¢–µ—Å—Ç 2: –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
```bash
# –° —É–Ω–∏–∫–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ - —Å–æ–∑–¥–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ
curl -X POST "http://localhost:8000/api/v1/client_bookings" \
  -d '{"client": {"phone": "+380671234888", "email": "unique@test.com"}, ...}'
```

## üéØ –†–ï–ó–£–õ–¨–¢–ê–¢

### ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:
1. **–û—à–∏–±–∫–∞ "wrong number of arguments"** - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã –∏–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
2. **–ù–µ–∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ –æ—à–∏–±–∫–∏** - —Ç–µ–ø–µ—Ä—å API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
3. **–°—Ç–∞—Ç—É—Å HTTP 409 Conflict** - –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∫–æ–¥ –¥–ª—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –¥–∞–Ω–Ω—ã—Ö
4. **–£–ª—É—á—à–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø–æ–∏—Å–∫–∞** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É –ò email –æ—Ç–¥–µ–ª—å–Ω–æ
5. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–µ–∑ –∫–ª–∏–µ–Ω—Ç–æ–≤** - –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É

### üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:
1. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è ExistingUserDialog** - –ø–æ–∫–∞–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å —Ñ–æ—Ä–º–æ–π –≤—Ö–æ–¥–∞
2. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã** –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –≤—Ö–æ–¥–µ
3. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Ñ–æ—Ä–º—ã** –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
4. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ UX** –ø–æ–ª–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞

### üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:
- **–§–∞–π–ª–æ–≤ –∏–∑–º–µ–Ω–µ–Ω–æ**: 2
- **–°—Ç—Ä–æ–∫ –∫–æ–¥–∞**: +50/-10
- **–°—Ç–∞—Ç—É—Å –æ—à–∏–±–∫–∏**: 422 ‚Üí 409
- **–í—Ä–µ–º—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è**: ~2 —á–∞—Å–∞

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### API Response Format
```typescript
interface ConflictResponse {
  error: string;
  details: string[];
  existing_user: {
    id: number;
    first_name: string;
    last_name: string;
    email: string;
    phone: string;
    role: string;
    client_id: number | null;
  };
}
```

### –õ–æ–≥–∏–∫–∞ –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏–π
1. **–ü–æ–∏—Å–∫ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É** ‚Üí –Ω–∞–π–¥–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí –≤–æ–∑–≤—Ä–∞—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞
2. **–ü–æ–∏—Å–∫ –ø–æ email** ‚Üí –Ω–∞–π–¥–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí –≤–æ–∑–≤—Ä–∞—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞  
3. **–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ** ‚Üí —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –∫–ª–∏–µ–Ω—Ç–∞
4. **–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å** ‚Üí –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞

---

**–î–∞—Ç–∞**: 2025-01-28  
**–ê–≤—Ç–æ—Ä**: AI Assistant  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: –í—ã—Å–æ–∫–∏–π (–±–ª–æ–∫–∏—Ä—É—é—â–∞—è –æ—à–∏–±–∫–∞) 