# Отчет: Исправление логики подсчета доступности бронирований

## Дата: 26 июня 2025
## Статус: ✅ ЗАВЕРШЕНО

## Описание проблемы

**Проблема:** Неправильный подсчет свободных слотов для бронирования.

**Пример:**
- Тестовая точка для бронирования (ID: 18)
- г. Дніпро, ул. Тестовая, 123
- Количество слотов: 12 (правильно)
- Записей на бронирование: 5
- Свободных слотов: 2 (правильно)
- **НО:** время 19:10 показывается как свободное, но при попытке забронировать выдается сообщение "это время занято"

## Корневая причина

**Несогласованность между генерацией слотов и проверкой доступности:**

1. **При генерации слотов** система создавала слот 19:10-20:00 (50 минут по длительности поста)
2. **При бронировании** система пыталась забронировать 60 минут (19:10-20:10), что выходило за рабочие часы (до 20:00)

## Исправления

### 1. Обновлен метод `check_availability_at_time` в `DynamicAvailabilityService`

**Файл:** `app/services/dynamic_availability_service.rb`

**Изменения:**
```ruby
# Получаем доступные слоты для проверки реальной доступности
available_slots = available_slots_for_date(service_point_id, date)

# Ищем слот, который начинается в указанное время
matching_slot = available_slots.find { |slot| slot[:start_time] == check_time.strftime('%H:%M') }

# Если есть слот, проверяем, достаточно ли его длительности
if matching_slot
  slot_duration = matching_slot[:duration_minutes]
  if duration_minutes > slot_duration
    return { 
      available: false, 
      reason: "Недостаточная длительность слота (доступно #{slot_duration} мин, требуется #{duration_minutes} мин)",
      available_duration: slot_duration,
      requested_duration: duration_minutes
    }
  end
end

# Определяем время окончания бронирования
if matching_slot
  # Используем длительность слота
  end_time = check_time + matching_slot[:duration_minutes].minutes
else
  # Используем переданную длительность
  end_time = check_time + duration_minutes.minutes
end
```

### 2. Обновлен метод `calculate_duration_minutes` в `ClientBookingsController`

**Файл:** `app/controllers/api/v1/client_bookings_controller.rb`

**Изменения:**
```ruby
# Если нет услуг, используем длительность слота сервисной точки
booking_data = booking_params
if booking_data[:service_point_id].present? && booking_data[:start_time].present?
  service_point = ServicePoint.find_by(id: booking_data[:service_point_id])
  if service_point
    # Получаем доступные слоты для указанной даты
    date = Date.parse(booking_data[:booking_date])
    available_slots = DynamicAvailabilityService.available_slots_for_date(service_point.id, date)
    
    # Ищем слот, который начинается в указанное время
    matching_slot = available_slots.find { |slot| slot[:start_time] == booking_data[:start_time] }
    
    if matching_slot
      return matching_slot[:duration_minutes]
    end
  end
end
```

## Результаты тестирования

### ✅ Проверка доступности времени 19:10

**До исправления:**
- Слот 19:10-20:00 (50 мин) показывался как доступный
- При попытке забронировать 60 мин: ошибка "Недостаточно времени до закрытия"

**После исправления:**
- С длительностью 50 мин: `{"available": true}` ✅
- С длительностью 60 мин: `{"available": false, "reason": "Недостаточная длительность слота (доступно 50 мин, требуется 60 мин)"}` ✅

### ✅ API тестирование

```bash
# Проверка доступности
curl -X POST "http://localhost:8000/api/v1/client_bookings/check_availability_for_booking"
# Результат: {"available": true, "service_point_id": 18, "date": "2025-06-27", "time": "19:10"}
```

### ✅ Расчет длительности в контроллере

**Результат:** Рассчитанная длительность: 50 минут (правильно!)

## Техническое решение

1. **Согласованность логики:** Теперь и генерация слотов, и проверка доступности используют одинаковую длительность
2. **Детальные сообщения об ошибках:** Система объясняет, почему слот недоступен
3. **Учет реальных слотов:** Проверка доступности основана на реально существующих слотах, а не на абстрактных временных интервалах

## Влияние на систему

✅ **Положительные изменения:**
- Устранена путаница между отображением доступности и реальной возможностью бронирования
- Пользователи получают понятные сообщения об ошибках
- Система использует правильную длительность слотов (50 мин вместо 60 мин по умолчанию)

⚠️ **Потенциальные риски:**
- Минимальные: изменения затрагивают только логику проверки доступности
- Обратная совместимость сохранена

## Статистика

**Тестовая точка ID=18 на 27.06.2025:**
- Всего возможных слотов: 12
- Занятых слотов: 5 (статус pending)
- Доступных слотов: 2 (включая 19:10-20:00)
- Процент загрузки: корректно рассчитывается

## Заключение

Проблема **полностью решена**. Система теперь корректно:
1. Отображает доступные слоты
2. Проверяет возможность бронирования
3. Использует правильную длительность слотов
4. Предоставляет понятные сообщения об ошибках

**Время 19:10 теперь можно забронировать без ошибок при использовании правильной длительности (50 минут).** 