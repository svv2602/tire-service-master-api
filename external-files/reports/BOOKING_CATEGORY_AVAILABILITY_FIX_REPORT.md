# üéØ –û–¢–ß–ï–¢: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å –∫–∞—Ç–µ–≥–æ—Ä–∏–µ–π

## üìã –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

**–°–∏–º–ø—Ç–æ–º—ã:**
- –°–ª–æ—Ç—ã –æ—Ç–æ–±—Ä–∞–∂–∞–ª–∏—Å—å –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ –≤—ã–±–æ—Ä–∞ –≤—Ä–µ–º–µ–Ω–∏
- –ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ —Å–æ–∑–¥–∞—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—è–≤–ª—è–ª–∞—Å—å –æ—à–∏–±–∫–∞ "–≤—ã–±—Ä–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ"
- API –≤–æ–∑–≤—Ä–∞—â–∞–ª —Å–ª–æ—Ç—ã –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏, –Ω–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –Ω–µ —É—á–∏—Ç—ã–≤–∞–ª–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—é

**–ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞:**
–ú–µ—Ç–æ–¥ `check_availability_at_time` –≤ `DynamicAvailabilityService` –Ω–µ —É—á–∏—Ç—ã–≤–∞–ª –∫–∞—Ç–µ–≥–æ—Ä–∏—é —É—Å–ª—É–≥ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –≤—Ä–µ–º–µ–Ω–∏, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—é –º–µ–∂–¥—É –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã–º–∏ —Å–ª–æ—Ç–∞–º–∏ –∏ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏.

## üîß –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. Frontend: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤

**–§–∞–π–ª:** `tire-service-master-web/src/pages/bookings/components/DateTimeStep.tsx`

**–ü—Ä–æ–±–ª–µ–º–∞:** –§—Ä–æ–Ω—Ç–µ–Ω–¥ –æ–∂–∏–¥–∞–ª –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–ª–æ—Ç—ã –ø–æ –≤—Ä–µ–º–µ–Ω–∏, –Ω–æ API –≤–æ–∑–≤—Ä–∞—â–∞–ª –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —Å–ª–æ—Ç—ã –ø–æ—Å—Ç–æ–≤.

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
// –ü–æ–ª—É—á–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–ª–æ—Ç—ã
const availableTimeSlots = useMemo(() => {
  if (!availabilityData?.slots || availabilityData.slots.length === 0) {
    return [];
  }

  // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —Å–ª–æ—Ç—ã –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞—á–∞–ª–∞
  const groupedByTime = availabilityData.slots.reduce((acc, slot) => {
    const timeKey = slot.start_time;
    
    if (!acc[timeKey]) {
      acc[timeKey] = {
        time: timeKey,
        posts: [],
        available_posts: 0,
        total_posts: 0
      };
    }
    
    acc[timeKey].posts.push(slot);
    acc[timeKey].available_posts += 1; // –í—Å–µ —Å–ª–æ—Ç—ã –≤ –æ—Ç–≤–µ—Ç–µ –¥–æ—Å—Ç—É–ø–Ω—ã
    acc[timeKey].total_posts += 1;
    
    return acc;
  }, {} as Record<string, {
    time: string;
    posts: any[];
    available_posts: number;
    total_posts: number;
  }>);

  // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ –º–∞—Å—Å–∏–≤ –∏ —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏
  return Object.values(groupedByTime)
    .map(group => ({
      time: group.time,
      available_posts: group.available_posts,
      total_posts: group.total_posts,
      can_book: group.available_posts > 0
    }))
    .sort((a, b) => a.time.localeCompare(b.time));
}, [availabilityData]);
```

### 2. Frontend: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∏–ø–æ–≤ API

**–§–∞–π–ª:** `tire-service-master-web/src/api/availability.api.ts`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
```typescript
export interface TimeSlot {
  service_post_id: number;
  post_number: number;
  post_name: string;
  category_id: string;
  category_name: string;
  start_time: string;
  end_time: string;
  duration_minutes: number;
  datetime: string;
}

export interface CategorySlotsResponse {
  service_point_id: string;
  category_id: string;
  date: string;
  slots: TimeSlot[];
  total_slots: number;
}
```

### 3. Backend: –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –º–µ—Ç–æ–¥–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏

**–§–∞–π–ª:** `tire-service-master-api/app/services/dynamic_availability_service.rb`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
```ruby
def self.check_availability_at_time(service_point_id, date, time, duration_minutes = nil, exclude_booking_id: nil, category_id: nil)
  # ...
  
  # –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–ª–æ—Ç—ã –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
  available_slots = if category_id.present?
    available_slots_for_category(service_point_id, date, category_id)
  else
    available_slots_for_date(service_point_id, date)
  end
  
  # –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤ –¥–ª—è –¥–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏–ª–∏ –≤—Å–µ—Ö –ø–æ—Å—Ç–æ–≤
  if category_id.present?
    # –î–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    category_posts = service_point.service_posts.where(service_category_id: category_id, is_active: true)
    total_posts = category_posts.count
  else
    # –î–ª—è –≤—Å–µ—Ö –ø–æ—Å—Ç–æ–≤ (—Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ª–æ–≥–∏–∫–∞)
    # ...
  end
  
  # ...
end
```

### 4. Backend: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π

**–§–∞–π–ª:** `tire-service-master-api/app/controllers/api/v1/client_bookings_controller.rb`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**

1. **–î–æ–±–∞–≤–ª–µ–Ω–∏–µ service_category_id –≤ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**
```ruby
def booking_params
  params_data = params.require(:booking).permit(
    :service_point_id,
    :service_category_id,  # ‚Üê –î–û–ë–ê–í–õ–ï–ù–û
    :booking_date,
    :start_time,
    # ...
  )
end
```

2. **–ü–µ—Ä–µ–¥–∞—á–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏:**
```ruby
def perform_availability_check
  booking_data = booking_params
  
  DynamicAvailabilityService.check_availability_at_time(
    booking_data[:service_point_id].to_i,
    Date.parse(booking_data[:booking_date]),
    Time.parse("#{booking_data[:booking_date]} #{booking_data[:start_time]}"),
    calculate_duration_minutes,
    nil, # exclude_booking_id
    booking_data[:service_category_id] # ‚Üê –î–û–ë–ê–í–õ–ï–ù–û
  )
end
```

3. **–£—á–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:**
```ruby
def calculate_duration_minutes
  # ...
  # –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–ª–æ—Ç—ã –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
  available_slots = if booking_data[:service_category_id].present?
    DynamicAvailabilityService.available_slots_for_category(
      service_point.id, date, booking_data[:service_category_id]
    )
  else
    DynamicAvailabilityService.available_slots_for_date(service_point.id, date)
  end
  # ...
end
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–°–æ–∑–¥–∞–Ω —Ç–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª: `external-files/testing/test_booking_creation_with_category.html`

**–°—Ü–µ–Ω–∞—Ä–∏–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:**
1. ‚úÖ –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
2. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ —Å —É—á–µ—Ç–æ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏  
3. ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏

**–¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ:**
- –°–µ—Ä–≤–∏—Å–Ω–∞—è —Ç–æ—á–∫–∞: ID 44
- –ö–∞—Ç–µ–≥–æ—Ä–∏—è: ID 6 (–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ)
- –î–∞—Ç–∞: 2025-06-28
- –í—Ä–µ–º—è: 09:00
- –¢–∏–ø –∞–≤—Ç–æ–º–æ–±–∏–ª—è: ID 1

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- ‚ùå API –≤–æ–∑–≤—Ä–∞—â–∞–ª —Å–ª–æ—Ç—ã –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
- ‚ùå –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–ª–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—é
- ‚ùå –û—à–∏–±–∫–∞ "–≤—ã–±—Ä–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ" –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- ‚úÖ –°–ª–æ—Ç—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –≥—Ä—É–ø–ø–∏—Ä—É—é—Ç—Å—è –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —É—á–∏—Ç—ã–≤–∞–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏—é —É—Å–ª—É–≥
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–ª–æ—Ç–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏

## üéØ –ö–ª—é—á–µ–≤—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

1. **–ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö:** –¢–µ–ø–µ—Ä—å –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã–µ —Å–ª–æ—Ç—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–π –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
2. **–£—á–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–π:** –°–∏—Å—Ç–µ–º–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å —Ä–∞–∑–Ω—ã–º–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ —É—Å–ª—É–≥
3. **–¢–æ—á–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ä–µ–∞–ª—å–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–ª–æ—Ç–æ–≤ –ø–æ—Å—Ç–æ–≤ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
4. **–õ—É—á—à–∏–π UX:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–∏–¥—è—Ç —Ç–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω–æ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å–ª–æ—Ç—ã

## üîÑ –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

- ‚úÖ –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ API
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –±–µ–∑ —É–∫–∞–∑–∞–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (fallback –Ω–∞ –≤—Å–µ –ø–æ—Å—Ç—ã)
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –ª–æ–≥–∏–∫–∏ –¥–ª—è –∞–¥–º–∏–Ω—Å–∫–∏—Ö –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π

## üìù –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ü—Ä–æ–±–ª–µ–º–∞ "–≤—ã–±—Ä–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ" –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ—à–µ–Ω–∞. –°–∏—Å—Ç–µ–º–∞ —Ç–µ–ø–µ—Ä—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å —É—á–µ—Ç–æ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–π —É—Å–ª—É–≥, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –º–µ–∂–¥—É –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã–º–∏ —Å–ª–æ—Ç–∞–º–∏ –∏ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–π –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å—é –≤—Ä–µ–º–µ–Ω–∏.

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–ê–í–ï–†–®–ï–ù–û  
**–î–∞—Ç–∞:** 2025-06-26  
**–ö–æ–º–º–∏—Ç—ã:** Backend + Frontend –∏–∑–º–µ–Ω–µ–Ω–∏—è 