<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –≥–æ—Å—Ç–µ–≤–æ–≥–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>üß™ –¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –≥–æ—Å—Ç–µ–≤–æ–≥–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</h1>
    <p>–ü—Ä–æ–≤–µ—Ä–∫–∞ API –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –±–µ–∑ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞</p>

    <div class="test-section info">
        <h3>üìã –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ</h3>
        <pre id="testData"></pre>
    </div>

    <div class="test-section">
        <h3>1Ô∏è‚É£ –°–æ–∑–¥–∞–Ω–∏–µ –≥–æ—Å—Ç–µ–≤–æ–≥–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</h3>
        <p>–°–æ–∑–¥–∞–µ–º –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑ –ø–µ—Ä–µ–¥–∞—á–∏ client_id</p>
        <button onclick="createGuestBooking()">–°–æ–∑–¥–∞—Ç—å –≥–æ—Å—Ç–µ–≤–æ–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
        <div id="guestBookingResult" class="result"></div>
    </div>

    <div class="test-section">
        <h3>2Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</h3>
        <p>–ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞–ª–æ—Å—å —Å client_id = null</p>
        <button onclick="checkBooking()" disabled id="checkBookingBtn">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
        <div id="checkBookingResult" class="result"></div>
    </div>

    <div class="test-section">
        <h3>3Ô∏è‚É£ –°–æ–∑–¥–∞–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</h3>
        <p>–î–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å–æ–∑–¥–∞–µ–º –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π</p>
        <button onclick="loginAndCreateBooking()">–í–æ–π—Ç–∏ –∏ —Å–æ–∑–¥–∞—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
        <div id="authBookingResult" class="result"></div>
    </div>

    <script>
        let createdBookingId = null;
        let authToken = null;

        // –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
        const testData = {
            guestBooking: {
                booking: {
                    service_point_id: 1,
                    service_category_id: 1,
                    booking_date: "2025-07-15",
                    start_time: "10:00",
                    service_recipient_first_name: "–ì–æ—Å—Ç—å",
                    service_recipient_last_name: "–¢–µ—Å—Ç–æ–≤—ã–π",
                    service_recipient_phone: "+380671234567",
                    service_recipient_email: "guest@test.com",
                    notes: "–ì–æ—Å—Ç–µ–≤–æ–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"
                },
                car: {
                    car_type_id: 1,
                    car_brand: "Toyota",
                    car_model: "Camry",
                    license_plate: "AA1234BB"
                },
                services: [],
                duration_minutes: 60
            },
            authUser: {
                email: "client@test.com",
                password: "client123"
            }
        };

        document.getElementById('testData').textContent = JSON.stringify(testData, null, 2);

        async function apiRequest(url, options = {}) {
            try {
                const response = await fetch(`http://localhost:8000${url}`, {
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        ...(authToken && { 'Authorization': `Bearer ${authToken}` }),
                        ...options.headers
                    },
                    ...options
                });

                const data = await response.json();
                return { 
                    success: response.ok, 
                    status: response.status, 
                    data 
                };
            } catch (error) {
                return { 
                    success: false, 
                    error: error.message 
                };
            }
        }

        async function createGuestBooking() {
            console.log('üöÄ –°–æ–∑–¥–∞–Ω–∏–µ –≥–æ—Å—Ç–µ–≤–æ–≥–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è...');
            
            const result = await apiRequest('/api/v1/client_bookings', {
                method: 'POST',
                body: JSON.stringify(testData.guestBooking)
            });

            const resultDiv = document.getElementById('guestBookingResult');
            
            if (result.success) {
                createdBookingId = result.data.id;
                resultDiv.className = 'result success';
                resultDiv.innerHTML = `
                    <h4>‚úÖ –ì–æ—Å—Ç–µ–≤–æ–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ —É—Å–ø–µ—à–Ω–æ!</h4>
                    <p><strong>ID –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:</strong> ${result.data.id}</p>
                    <p><strong>Client ID:</strong> ${result.data.client_id || 'null (–≥–æ—Å—Ç–µ–≤–æ–µ)'}</p>
                    <p><strong>–ü–æ–ª—É—á–∞—Ç–µ–ª—å:</strong> ${result.data.service_recipient?.first_name} ${result.data.service_recipient?.last_name}</p>
                    <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> ${result.data.service_recipient?.phone}</p>
                    <p><strong>–°—Ç–∞—Ç—É—Å:</strong> ${result.data.status?.name}</p>
                    <pre>${JSON.stringify(result.data, null, 2)}</pre>
                `;
                document.getElementById('checkBookingBtn').disabled = false;
            } else {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `
                    <h4>‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</h4>
                    <p><strong>–°—Ç–∞—Ç—É—Å:</strong> ${result.status}</p>
                    <pre>${JSON.stringify(result.data || result.error, null, 2)}</pre>
                `;
            }
        }

        async function checkBooking() {
            if (!createdBookingId) {
                alert('–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ');
                return;
            }

            console.log('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è...');
            
            const result = await apiRequest(`/api/v1/bookings/${createdBookingId}`);

            const resultDiv = document.getElementById('checkBookingResult');
            
            if (result.success) {
                const booking = result.data;
                const isGuestBooking = booking.client_id === null;
                
                resultDiv.className = `result ${isGuestBooking ? 'success' : 'error'}`;
                resultDiv.innerHTML = `
                    <h4>${isGuestBooking ? '‚úÖ' : '‚ùå'} –ü—Ä–æ–≤–µ—Ä–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</h4>
                    <p><strong>–¢–∏–ø:</strong> ${isGuestBooking ? '–ì–æ—Å—Ç–µ–≤–æ–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ' : '–ö–ª–∏–µ–Ω—Ç—Å–∫–æ–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ'}</p>
                    <p><strong>Client ID:</strong> ${booking.client_id || 'null'}</p>
                    <p><strong>–ü–æ–ª—É—á–∞—Ç–µ–ª—å:</strong> ${booking.service_recipient?.first_name} ${booking.service_recipient?.last_name}</p>
                    <p><strong>–ö–æ–Ω—Ç–∞–∫—Ç—ã:</strong> ${booking.service_recipient?.phone}, ${booking.service_recipient?.email}</p>
                    <p><strong>–î–∞—Ç–∞:</strong> ${booking.booking_date} ${booking.start_time}</p>
                    <pre>${JSON.stringify(booking, null, 2)}</pre>
                `;
            } else {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `
                    <h4>‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</h4>
                    <p><strong>–°—Ç–∞—Ç—É—Å:</strong> ${result.status}</p>
                    <pre>${JSON.stringify(result.data || result.error, null, 2)}</pre>
                `;
            }
        }

        async function loginAndCreateBooking() {
            console.log('üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è...');
            
            // –°–Ω–∞—á–∞–ª–∞ –∞–≤—Ç–æ—Ä–∏–∑—É–µ–º—Å—è
            const loginResult = await apiRequest('/api/v1/auth/login', {
                method: 'POST',
                body: JSON.stringify(testData.authUser)
            });

            if (!loginResult.success) {
                const resultDiv = document.getElementById('authBookingResult');
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `
                    <h4>‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</h4>
                    <pre>${JSON.stringify(loginResult.data || loginResult.error, null, 2)}</pre>
                `;
                return;
            }

            authToken = loginResult.data.token;
            console.log('‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞');

            // –¢–µ–ø–µ—Ä—å —Å–æ–∑–¥–∞–µ–º –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π
            const bookingData = {
                ...testData.guestBooking,
                booking: {
                    ...testData.guestBooking.booking,
                    service_recipient_first_name: "–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π",
                    service_recipient_last_name: "–ö–ª–∏–µ–Ω—Ç",
                    service_recipient_phone: "+380671234568",
                    booking_date: "2025-07-16",
                    notes: "–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞"
                }
            };

            const bookingResult = await apiRequest('/api/v1/client_bookings', {
                method: 'POST',
                body: JSON.stringify(bookingData)
            });

            const resultDiv = document.getElementById('authBookingResult');
            
            if (bookingResult.success) {
                const booking = bookingResult.data;
                const hasClientId = booking.client_id !== null;
                
                resultDiv.className = `result ${hasClientId ? 'success' : 'error'}`;
                resultDiv.innerHTML = `
                    <h4>${hasClientId ? '‚úÖ' : '‚ùå'} –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</h4>
                    <p><strong>–¢–∏–ø:</strong> ${hasClientId ? '–ö–ª–∏–µ–Ω—Ç—Å–∫–æ–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ' : '–ì–æ—Å—Ç–µ–≤–æ–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ'}</p>
                    <p><strong>Client ID:</strong> ${booking.client_id || 'null'}</p>
                    <p><strong>–ü–æ–ª—É—á–∞—Ç–µ–ª—å:</strong> ${booking.service_recipient?.first_name} ${booking.service_recipient?.last_name}</p>
                    <p><strong>–ö–ª–∏–µ–Ω—Ç:</strong> ${booking.client?.name || 'N/A'}</p>
                    <pre>${JSON.stringify(booking, null, 2)}</pre>
                `;
            } else {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `
                    <h4>‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</h4>
                    <p><strong>–°—Ç–∞—Ç—É—Å:</strong> ${bookingResult.status}</p>
                    <pre>${JSON.stringify(bookingResult.data || bookingResult.error, null, 2)}</pre>
                `;
            }
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–≤—ã–π —Ç–µ—Å—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
        setTimeout(() => {
            console.log('üé¨ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è...');
            createGuestBooking();
        }, 1000);
    </script>
</body>
</html> 