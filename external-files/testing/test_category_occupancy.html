<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —É—Å–ª—É–≥</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-result {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
            border-left: 4px solid #007bff;
            background-color: #f8f9fa;
        }
        .success { border-left-color: #28a745; background-color: #d4edda; }
        .error { border-left-color: #dc3545; background-color: #f8d7da; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .comparison {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        .comparison > div {
            flex: 1;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #f9f9f9;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .stat-item {
            padding: 10px;
            background: white;
            border-radius: 4px;
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <h1>üîß –¢–µ—Å—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —É—Å–ª—É–≥</h1>
    
    <div class="test-container">
        <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–µ—Å—Ç–∞</h2>
        <div>
            <label>–°–µ—Ä–≤–∏—Å–Ω–∞—è —Ç–æ—á–∫–∞ ID: 
                <input type="number" id="servicePointId" value="1" min="1">
            </label>
        </div>
        <div style="margin-top: 10px;">
            <label>–î–∞—Ç–∞: 
                <input type="date" id="testDate" value="2025-06-30">
            </label>
        </div>
        <div style="margin-top: 10px;">
            <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è —É—Å–ª—É–≥ ID (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –≤—Å–µ—Ö): 
                <input type="number" id="categoryId" value="1" min="1" placeholder="–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏">
            </label>
        </div>
        <div style="margin-top: 15px;">
            <button onclick="testAllOccupancy()">–¢–µ—Å—Ç –æ–±—â–µ–π –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç–∏</button>
            <button onclick="testCategoryOccupancy()">–¢–µ—Å—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</button>
            <button onclick="testComparison()">–°—Ä–∞–≤–Ω–∏—Ç—å –æ–±–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞</button>
        </div>
    </div>

    <div class="test-container">
        <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤</h2>
        <div id="results"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api/v1';
        
        function addResult(title, content, isSuccess = true) {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `test-result ${isSuccess ? 'success' : 'error'}`;
            div.innerHTML = `<strong>${title}</strong><br>${content}`;
            results.appendChild(div);
        }

        function formatOccupancyData(data, title) {
            if (!data.summary) {
                return `<strong>${title}</strong><br>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç–∏`;
            }

            const summary = data.summary;
            return `
                <strong>${title}</strong>
                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-value">${summary.total_slots}</div>
                        <div class="stat-label">–í—Å–µ–≥–æ —Å–ª–æ—Ç–æ–≤</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" style="color: #28a745;">${summary.available_slots}</div>
                        <div class="stat-label">–°–≤–æ–±–æ–¥–Ω–æ —Å–ª–æ—Ç–æ–≤</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" style="color: #dc3545;">${summary.occupied_slots}</div>
                        <div class="stat-label">–ó–∞–Ω—è—Ç–æ —Å–ª–æ—Ç–æ–≤</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${summary.occupancy_percentage}%</div>
                        <div class="stat-label">–ó–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç—å</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${data.total_posts || 0}</div>
                        <div class="stat-label">–ü–æ—Å—Ç–æ–≤ ${data.category_id ? '–≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏' : '–≤—Å–µ–≥–æ'}</div>
                    </div>
                </div>
                <div style="margin-top: 10px; font-size: 12px; color: #666;">
                    –†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è: ${data.opening_time || 'N/A'} - ${data.closing_time || 'N/A'}
                    ${data.category_id ? ` | –ö–∞—Ç–µ–≥–æ—Ä–∏—è ID: ${data.category_id}` : ''}
                </div>
            `;
        }

        async function testAllOccupancy() {
            const servicePointId = document.getElementById('servicePointId').value;
            const date = document.getElementById('testDate').value;
            
            try {
                addResult('üîÑ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—â–µ–π –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç–∏...', '–ó–∞–ø—Ä–æ—Å –∫ API...');
                
                const response = await fetch(`${API_BASE}/service_points/${servicePointId}/availability/${date}/details`);
                const data = await response.json();
                
                if (response.ok) {
                    addResult(
                        '‚úÖ –û–±—â–∞—è –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç—å –ø–æ–ª—É—á–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ',
                        formatOccupancyData(data, '–ó–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç—å –ø–æ –≤—Å–µ–º –ø–æ—Å—Ç–∞–º'),
                        true
                    );
                } else {
                    addResult('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±—â–µ–π –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç–∏', JSON.stringify(data, null, 2), false);
                }
            } catch (error) {
                addResult('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ–±—â–µ–π –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç–∏', error.message, false);
            }
        }

        async function testCategoryOccupancy() {
            const servicePointId = document.getElementById('servicePointId').value;
            const date = document.getElementById('testDate').value;
            const categoryId = document.getElementById('categoryId').value;
            
            if (!categoryId) {
                addResult('‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ', '–£–∫–∞–∂–∏—Ç–µ ID –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è', false);
                return;
            }
            
            try {
                addResult('üîÑ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏...', `–ó–∞–ø—Ä–æ—Å –∫ API –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ${categoryId}...`);
                
                const response = await fetch(`${API_BASE}/service_points/${servicePointId}/availability/${date}/details?category_id=${categoryId}`);
                const data = await response.json();
                
                if (response.ok) {
                    addResult(
                        '‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç—å –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ–ª—É—á–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ',
                        formatOccupancyData(data, `–ó–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç—å –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ${categoryId}`),
                        true
                    );
                } else {
                    addResult('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏', JSON.stringify(data, null, 2), false);
                }
            } catch (error) {
                addResult('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏', error.message, false);
            }
        }

        async function testComparison() {
            const servicePointId = document.getElementById('servicePointId').value;
            const date = document.getElementById('testDate').value;
            const categoryId = document.getElementById('categoryId').value;
            
            if (!categoryId) {
                addResult('‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ', '–£–∫–∞–∂–∏—Ç–µ ID –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è', false);
                return;
            }
            
            try {
                addResult('üîÑ –°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Ç–µ—Å—Ç...', '–ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ –æ–±–æ–∏–º –≤–∞—Ä–∏–∞–Ω—Ç–∞–º...');
                
                // –ó–∞–ø—Ä–æ—Å –æ–±—â–µ–π –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç–∏
                const allResponse = await fetch(`${API_BASE}/service_points/${servicePointId}/availability/${date}/details`);
                const allData = await allResponse.json();
                
                // –ó–∞–ø—Ä–æ—Å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                const categoryResponse = await fetch(`${API_BASE}/service_points/${servicePointId}/availability/${date}/details?category_id=${categoryId}`);
                const categoryData = await categoryResponse.json();
                
                if (allResponse.ok && categoryResponse.ok) {
                    const comparisonHtml = `
                        <div class="comparison">
                            <div>
                                ${formatOccupancyData(allData, '–í—Å–µ –ø–æ—Å—Ç—ã')}
                            </div>
                            <div>
                                ${formatOccupancyData(categoryData, `–ö–∞—Ç–µ–≥–æ—Ä–∏—è ${categoryId}`)}
                            </div>
                        </div>
                        <div style="margin-top: 15px; padding: 10px; background: #e3f2fd; border-radius: 4px;">
                            <strong>üìä –ê–Ω–∞–ª–∏–∑ —Ä–∞–∑–ª–∏—á–∏–π:</strong><br>
                            ‚Ä¢ –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Å—Ç–æ–≤: ${allData.total_posts || 0}<br>
                            ‚Ä¢ –ü–æ—Å—Ç–æ–≤ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ${categoryId}: ${categoryData.total_posts || 0}<br>
                            ‚Ä¢ –†–∞–∑–Ω–∏—Ü–∞ –≤ —Å–ª–æ—Ç–∞—Ö: ${(allData.summary?.total_slots || 0) - (categoryData.summary?.total_slots || 0)}<br>
                            ‚Ä¢ –†–∞–∑–Ω–∏—Ü–∞ –≤ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç–∏: ${((allData.summary?.occupancy_percentage || 0) - (categoryData.summary?.occupancy_percentage || 0)).toFixed(1)}%
                        </div>
                    `;
                    
                    addResult('‚úÖ –°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω', comparisonHtml, true);
                } else {
                    addResult('‚ùå –û—à–∏–±–∫–∞ –≤ —Å—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–æ–º —Ç–µ—Å—Ç–µ', 
                        `–û–±—â–∞—è –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç—å: ${allResponse.status}<br>–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${categoryResponse.status}`, false);
                }
            } catch (error) {
                addResult('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –≤ —Å—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–æ–º —Ç–µ—Å—Ç–µ', error.message, false);
            }
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–µ—Å—Ç –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.onload = function() {
            addResult('üöÄ –¢–µ—Å—Ç–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞', '–ì–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é API –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º —É—Å–ª—É–≥');
        };
    </script>
</body>
</html>
