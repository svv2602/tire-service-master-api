<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç API –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–≥–æ—Ç–∏–ø–∞ –ø–∞—Ä—Ç–Ω–µ—Ä–∞</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-section {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success { border-color: #4CAF50; background-color: #f9fff9; }
        .error { border-color: #f44336; background-color: #fff9f9; }
        .info { border-color: #2196F3; background-color: #f9f9ff; }
        .warning { border-color: #ff9800; background-color: #fffaf0; }
        
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #45a049; }
        button:disabled { background-color: #cccccc; cursor: not-allowed; }
        
        input, select, textarea {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .preview-image {
            max-width: 200px;
            max-height: 200px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 10px 0;
        }
        
        pre {
            background-color: #f4f4f4;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ –¢–µ—Å—Ç API –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–≥–æ—Ç–∏–ø–∞ –ø–∞—Ä—Ç–Ω–µ—Ä–∞</h1>
        <p>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ backend API –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ª–æ–≥–æ—Ç–∏–ø–æ–≤ –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤</p>
    </div>

    <!-- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è -->
    <div class="container">
        <h2>üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2>
        <div class="form-group">
            <label>Email –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:</label>
            <input type="email" id="adminEmail" value="admin@test.com" />
        </div>
        <div class="form-group">
            <label>–ü–∞—Ä–æ–ª—å:</label>
            <input type="password" id="adminPassword" value="admin123" />
        </div>
        <button onclick="loginAdmin()">–í–æ–π—Ç–∏ –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</button>
        <div id="authResult" class="test-section info" style="display: none;"></div>
    </div>

    <!-- –í—ã–±–æ—Ä –ø–∞—Ä—Ç–Ω–µ—Ä–∞ -->
    <div class="container">
        <h2>üë• –í—ã–±–æ—Ä –ø–∞—Ä—Ç–Ω–µ—Ä–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h2>
        <div class="form-group">
            <label>–ü–∞—Ä—Ç–Ω–µ—Ä:</label>
            <select id="partnerSelect">
                <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –ø–∞—Ä—Ç–Ω–µ—Ä–∞ --</option>
            </select>
        </div>
        <button onclick="loadPartners()">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤</button>
        <button onclick="loadPartnerDetails()" disabled id="loadDetailsBtn">–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–µ—Ç–∞–ª–∏ –ø–∞—Ä—Ç–Ω–µ—Ä–∞</button>
        <div id="partnersResult" class="test-section info" style="display: none;"></div>
    </div>

    <!-- –¢–µ–∫—É—â–∏–π –ª–æ–≥–æ—Ç–∏–ø -->
    <div class="container">
        <h2>üñºÔ∏è –¢–µ–∫—É—â–∏–π –ª–æ–≥–æ—Ç–∏–ø –ø–∞—Ä—Ç–Ω–µ—Ä–∞</h2>
        <div id="currentLogo" class="test-section info">
            <p>–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞—Ä—Ç–Ω–µ—Ä–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –ª–æ–≥–æ—Ç–∏–ø–∞</p>
        </div>
    </div>

    <!-- –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤–æ–≥–æ –ª–æ–≥–æ—Ç–∏–ø–∞ -->
    <div class="container">
        <h2>üì§ –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤–æ–≥–æ –ª–æ–≥–æ—Ç–∏–ø–∞</h2>
        <div class="form-group">
            <label>–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –ª–æ–≥–æ—Ç–∏–ø–∞:</label>
            <input type="file" id="logoFile" accept="image/*" onchange="previewLogo()" />
        </div>
        <div id="logoPreview"></div>
        <button onclick="uploadLogo()" disabled id="uploadBtn">–ó–∞–≥—Ä—É–∑–∏—Ç—å –ª–æ–≥–æ—Ç–∏–ø</button>
        <div id="uploadResult" class="test-section info" style="display: none;"></div>
    </div>

    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
    <div class="container">
        <h2>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h2>
        <div id="testResults"></div>
        <button onclick="runAllTests()">–ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã</button>
        <button onclick="clearResults()">–û—á–∏—Å—Ç–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</button>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8000/api/v1';
        let authToken = '';
        let selectedPartnerId = null;
        let selectedPartnerData = null;

        // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
        async function loginAdmin() {
            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPassword').value;
            
            try {
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: email,
                        password: password
                    })
                });

                const data = await response.json();
                
                if (response.ok && data.tokens && data.tokens.access) {
                    authToken = data.tokens.access;
                    showResult('authResult', 'success', `‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!\n–¢–æ–∫–µ–Ω: ${authToken.substring(0, 50)}...`);
                    loadPartners();
                } else {
                    showResult('authResult', 'error', `‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ${data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
                }
            } catch (error) {
                showResult('authResult', 'error', `‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤
        async function loadPartners() {
            if (!authToken) {
                alert('–°–Ω–∞—á–∞–ª–∞ –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å!');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/partners`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                
                if (response.ok) {
                    const select = document.getElementById('partnerSelect');
                    select.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –ø–∞—Ä—Ç–Ω–µ—Ä–∞ --</option>';
                    
                    if (data.data && Array.isArray(data.data)) {
                        data.data.forEach(partner => {
                            const option = document.createElement('option');
                            option.value = partner.id;
                            option.textContent = `${partner.company_name} (ID: ${partner.id})`;
                            select.appendChild(option);
                        });
                        
                        select.addEventListener('change', function() {
                            selectedPartnerId = this.value;
                            document.getElementById('loadDetailsBtn').disabled = !selectedPartnerId;
                            if (selectedPartnerId) {
                                loadPartnerDetails();
                            }
                        });
                        
                        showResult('partnersResult', 'success', `‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${data.data.length} –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤`);
                    } else {
                        showResult('partnersResult', 'warning', '‚ö†Ô∏è –ü–∞—Ä—Ç–Ω–µ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
                    }
                } else {
                    showResult('partnersResult', 'error', `‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤: ${data.message || response.statusText}`);
                }
            } catch (error) {
                showResult('partnersResult', 'error', `‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–µ—Ç–∞–ª–µ–π –ø–∞—Ä—Ç–Ω–µ—Ä–∞
        async function loadPartnerDetails() {
            if (!selectedPartnerId) return;

            try {
                const response = await fetch(`${API_BASE_URL}/partners/${selectedPartnerId}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                
                if (response.ok) {
                    selectedPartnerData = data;
                    displayCurrentLogo(data);
                    document.getElementById('uploadBtn').disabled = false;
                } else {
                    showResult('partnersResult', 'error', `‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–µ–π: ${data.message || response.statusText}`);
                }
            } catch (error) {
                showResult('partnersResult', 'error', `‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`);
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –ª–æ–≥–æ—Ç–∏–ø–∞
        function displayCurrentLogo(partnerData) {
            const container = document.getElementById('currentLogo');
            let html = `<h3>${partnerData.company_name}</h3>`;
            
            if (partnerData.logo) {
                html += `
                    <div class="logo-container">
                        <img src="${partnerData.logo}" alt="–õ–æ–≥–æ—Ç–∏–ø ${partnerData.company_name}" class="preview-image" />
                        <div>
                            <p><strong>–¢–µ–∫—É—â–∏–π –ª–æ–≥–æ—Ç–∏–ø:</strong> –ó–∞–≥—Ä—É–∂–µ–Ω</p>
                            <p><strong>URL:</strong> <a href="${partnerData.logo}" target="_blank">${partnerData.logo}</a></p>
                        </div>
                    </div>
                `;
            } else if (partnerData.logo_url) {
                html += `
                    <div class="logo-container">
                        <img src="${partnerData.logo_url}" alt="–õ–æ–≥–æ—Ç–∏–ø ${partnerData.company_name}" class="preview-image" onerror="this.style.display='none'" />
                        <div>
                            <p><strong>–°—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç –ª–æ–≥–æ—Ç–∏–ø–∞ (URL):</strong> ${partnerData.logo_url}</p>
                        </div>
                    </div>
                `;
            } else {
                html += '<p>‚ùå –õ–æ–≥–æ—Ç–∏–ø –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω</p>';
            }
            
            container.innerHTML = html;
            container.className = 'test-section info';
            container.style.display = 'block';
        }

        // –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ª–æ–≥–æ—Ç–∏–ø–∞
        function previewLogo() {
            const fileInput = document.getElementById('logoFile');
            const previewContainer = document.getElementById('logoPreview');
            
            if (fileInput.files && fileInput.files[0]) {
                const file = fileInput.files[0];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    previewContainer.innerHTML = `
                        <div class="logo-container">
                            <img src="${e.target.result}" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä" class="preview-image" />
                            <div>
                                <p><strong>–§–∞–π–ª:</strong> ${file.name}</p>
                                <p><strong>–†–∞–∑–º–µ—Ä:</strong> ${(file.size / 1024 / 1024).toFixed(2)} MB</p>
                                <p><strong>–¢–∏–ø:</strong> ${file.type}</p>
                            </div>
                        </div>
                    `;
                };
                
                reader.readAsDataURL(file);
            } else {
                previewContainer.innerHTML = '';
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–≥–æ—Ç–∏–ø–∞
        async function uploadLogo() {
            const fileInput = document.getElementById('logoFile');
            
            if (!selectedPartnerId) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞—Ä—Ç–Ω–µ—Ä–∞!');
                return;
            }
            
            if (!fileInput.files || !fileInput.files[0]) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏!');
                return;
            }

            const formData = new FormData();
            formData.append('partner[logo]', fileInput.files[0]);

            try {
                const response = await fetch(`${API_BASE_URL}/partners/${selectedPartnerId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: formData
                });

                const data = await response.json();
                
                if (response.ok) {
                    showResult('uploadResult', 'success', `‚úÖ –õ–æ–≥–æ—Ç–∏–ø —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω!\n\n–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:\n${JSON.stringify(data, null, 2)}`);
                    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –ª–æ–≥–æ—Ç–∏–ø–∞
                    displayCurrentLogo(data);
                    // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                    fileInput.value = '';
                    document.getElementById('logoPreview').innerHTML = '';
                } else {
                    showResult('uploadResult', 'error', `‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–≥–æ—Ç–∏–ø–∞:\n${JSON.stringify(data, null, 2)}`);
                }
            } catch (error) {
                showResult('uploadResult', 'error', `‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`);
            }
        }

        // –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤
        async function runAllTests() {
            const results = document.getElementById('testResults');
            results.innerHTML = '<h3>üß™ –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ç–µ—Å—Ç–æ–≤...</h3>';
            
            const tests = [
                { name: '–¢–µ—Å—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏', func: testAuth },
                { name: '–¢–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤', func: testLoadPartners },
                { name: '–¢–µ—Å—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ñ–∞–π–ª–æ–≤', func: testFileValidation }
            ];
            
            for (const test of tests) {
                try {
                    const result = await test.func();
                    addTestResult(test.name, result.success, result.message);
                } catch (error) {
                    addTestResult(test.name, false, `–û—à–∏–±–∫–∞: ${error.message}`);
                }
            }
        }

        // –¢–µ—Å—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        async function testAuth() {
            try {
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'admin@test.com',
                        password: 'admin123'
                    })
                });
                
                const data = await response.json();
                return {
                    success: response.ok && data.tokens && data.tokens.access,
                    message: response.ok ? '–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ' : `–û—à–∏–±–∫–∞: ${data.message}`
                };
            } catch (error) {
                return { success: false, message: `–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}` };
            }
        }

        // –¢–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤
        async function testLoadPartners() {
            if (!authToken) {
                return { success: false, message: '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω' };
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/partners`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                return {
                    success: response.ok && data.data && Array.isArray(data.data),
                    message: response.ok ? `–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${data.data?.length || 0} –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤` : `–û—à–∏–±–∫–∞: ${data.message}`
                };
            } catch (error) {
                return { success: false, message: `–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}` };
            }
        }

        // –¢–µ—Å—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ñ–∞–π–ª–æ–≤
        async function testFileValidation() {
            // –≠—Ç–æ—Ç —Ç–µ—Å—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ API –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
            return {
                success: true,
                message: '–í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ –≤ –º–æ–¥–µ–ª–∏ Partner (—Ä–∞–∑–º–µ—Ä –¥–æ 5MB, —Ñ–æ—Ä–º–∞—Ç—ã: JPEG, PNG, GIF, WebP)'
            };
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function showResult(elementId, type, message) {
            const element = document.getElementById(elementId);
            element.className = `test-section ${type}`;
            element.innerHTML = `<pre>${message}</pre>`;
            element.style.display = 'block';
        }

        function addTestResult(testName, success, message) {
            const results = document.getElementById('testResults');
            const status = success ? '‚úÖ' : '‚ùå';
            const className = success ? 'success' : 'error';
            
            results.innerHTML += `
                <div class="test-section ${className}">
                    <strong>${status} ${testName}</strong>
                    <pre>${message}</pre>
                </div>
            `;
        }

        function clearResults() {
            document.getElementById('testResults').innerHTML = '';
            document.getElementById('authResult').style.display = 'none';
            document.getElementById('partnersResult').style.display = 'none';
            document.getElementById('uploadResult').style.display = 'none';
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üß™ –¢–µ—Å—Ç API –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–≥–æ—Ç–∏–ø–∞ –ø–∞—Ä—Ç–Ω–µ—Ä–∞ –∑–∞–≥—Ä—É–∂–µ–Ω');
        });
    </script>
</body>
</html> 