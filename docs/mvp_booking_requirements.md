# –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –¥–æ—Ä–∞–±–æ—Ç–∫–µ —Å–∏—Å—Ç–µ–º—ã –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –¥–ª—è MVP

## üö® –í–õ–ò–Ø–ù–ò–ï –ò–ù–î–ò–í–ò–î–£–ê–õ–¨–ù–´–• –ü–û–°–¢–û–í

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π
–° –≤–≤–µ–¥–µ–Ω–∏–µ–º –º–æ–¥–µ–ª–∏ **ServicePost** (–∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ—Å—Ç–æ–≤) —Å–∏—Å—Ç–µ–º–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –¥–æ–ª–∂–Ω–∞:

1. **–£—á–∏—Ç—ã–≤–∞—Ç—å —Ä–∞–∑–Ω—É—é –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ—Å—Ç–æ–≤** –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ –≤—Ä–µ–º–µ–Ω–∏
2. **–í–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ—Å—Ç–∞** —Å –µ–≥–æ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–π –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é
3. **–ü—Ä–∞–≤–∏–ª—å–Ω–æ —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞—Ç—å —Å–ª–æ—Ç—ã** —Å —É—á–µ—Ç–æ–º –≤—Ä–µ–º–µ–Ω–∏ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è –∫–∞–∂–¥–æ–≥–æ –ø–æ—Å—Ç–∞
4. **–ü—Ä–µ–¥–ª–∞–≥–∞—Ç—å –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ —Å–ª–æ—Ç—ã** –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∞–ª—å–Ω–æ–≥–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –ø–æ—Å—Ç–æ–≤

**–ü—Ä–∏–º–µ—Ä –≤–ª–∏—è–Ω–∏—è:**
- –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ 30 –º–∏–Ω—É—Ç –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –ü–æ—Å—Ç 1 (30 –º–∏–Ω) –ø–æ–ª–Ω–æ—Å—Ç—å—é
- –ù–æ –Ω–∞ –ü–æ—Å—Ç—É 2 (40 –º–∏–Ω) –æ—Å—Ç–∞–Ω–µ—Ç—Å—è 10 –º–∏–Ω—É—Ç "–ø—Ä–æ—Å—Ç–æ—è"
- –°–∏—Å—Ç–µ–º–∞ –¥–æ–ª–∂–Ω–∞ —ç—Ç–æ —É—á–∏—Ç—ã–≤–∞—Ç—å –ø—Ä–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è—Ö

---

## üéØ –¢–µ–∫—É—â–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –¥–ª—è —Ä–µ—à–µ–Ω–∏—è

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–ª–æ—Ç–æ–≤
- ‚ùå **–ü–†–û–ë–õ–ï–ú–ê**: –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–ª–æ—Ç–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
- ‚ùå **–ü–†–û–ë–õ–ï–ú–ê**: –í–æ–∑–º–æ–∂–Ω–æ —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –Ω–∞ –æ–¥–∏–Ω —Å–ª–æ—Ç
- ‚ùå **–ü–†–û–ë–õ–ï–ú–ê**: –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–π –ø–æ –≤—Ä–µ–º–µ–Ω–∏
- üö® **–ù–û–í–ê–Ø –ü–†–û–ë–õ–ï–ú–ê**: –ù–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ—Å—Ç–æ–≤

### 2. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç –≤—Ä–µ–º–µ–Ω–∏
- ‚ùå **–ü–†–û–ë–õ–ï–ú–ê**: –í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –≤—Ä—É—á–Ω—É—é
- ‚ùå **–ü–†–û–ë–õ–ï–ú–ê**: –ù–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —É—Å–ª—É–≥
- ‚ùå **–ü–†–û–ë–õ–ï–ú–ê**: –ù–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –≤—Ä–µ–º–µ–Ω–∏ –∏ —É—Å–ª—É–≥
- üö® **–ù–û–í–ê–Ø –ü–†–û–ë–õ–ï–ú–ê**: –ù–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –≤—Ä–µ–º—è –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ—Å—Ç–∞

### 3. –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
- ‚ùå **–ü–†–û–ë–õ–ï–ú–ê**: –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–π —Å –¥—Ä—É–≥–∏–º–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è–º–∏
- ‚ùå **–ü–†–û–ë–õ–ï–ú–ê**: –ù–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ø–æ—Å—Ç–∞ –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è
- ‚ùå **–ü–†–û–ë–õ–ï–ú–ê**: –ù–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π
- üö® **–ù–û–í–ê–Ø –ü–†–û–ë–õ–ï–ú–ê**: –ù–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ –ø–æ—Å—Ç–∞

## üõ† –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –¥–æ—Ä–∞–±–æ—Ç–∫–µ

### 1. –ú–æ–¥–µ–ª—å Booking - –¥–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏–∏

```ruby
# –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Å —É—á–µ—Ç–æ–º ServicePost:
validate :slot_must_be_available
validate :booking_time_matches_slot  
validate :services_fit_in_time_slot_for_post  # –û–ë–ù–û–í–ò–¢–¨: —É—á–µ—Ç ServicePost
validate :no_conflicting_bookings_for_post    # –û–ë–ù–û–í–ò–¢–¨: —É—á–µ—Ç ServicePost
validate :post_is_available_for_duration      # –ù–û–í–û–ï: –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å—Ç–∞

# –î–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–ª–±—ç–∫–∏:
before_validation :calculate_end_time_from_services_and_post  # –û–ë–ù–û–í–ò–¢–¨
before_create :reserve_slot_for_post                        # –û–ë–ù–û–í–ò–¢–¨
after_destroy :release_slot_for_post                        # –û–ë–ù–û–í–ò–¢–¨

# –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥—ã:
def calculate_total_duration_for_post(post)  # –ù–û–í–û–ï
def reserve_required_slots_for_post          # –û–ë–ù–û–í–ò–¢–¨
def release_reserved_slots_for_post          # –û–ë–ù–û–í–ò–¢–¨
def conflicts_with_other_bookings_on_post?   # –ù–û–í–û–ï
def find_optimal_post_for_services           # –ù–û–í–û–ï

# –î–æ–±–∞–≤–∏—Ç—å —Å–≤—è–∑–∏:
belongs_to :service_post, foreign_key: :post_number, primary_key: :post_number, optional: true
```

### 2. –°–µ—Ä–≤–∏—Å BookingManager (–∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ)

```ruby
class BookingManager
  # –°–æ–∑–¥–∞–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏ –ø–æ—Å—Ç–æ–≤
  def self.create_booking(params)
    # 1. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –ø–æ—Å—Ç –¥–ª—è —É—Å–ª—É–≥
    # 2. –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ—Å—Ç–∞
    # 3. –†–∞—Å—á–µ—Ç –≤—Ä–µ–º–µ–Ω–∏ —Å —É—á–µ—Ç–æ–º –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø–æ—Å—Ç–∞
    # 4. –†–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ª–æ—Ç–æ–≤ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ—Å—Ç–∞
    # 5. –°–æ–∑–¥–∞–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
    # 6. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ –æ—Ç–∫–∞—Ç
  end
  
  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å —É—á–µ—Ç–æ–º –ø–æ—Å—Ç–æ–≤
  def self.check_availability(service_point_id, date, start_time, services, preferred_post = nil)
    service_point = ServicePoint.find(service_point_id)
    required_duration = calculate_total_duration(services)
    
    # –ù–∞–π—Ç–∏ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø–æ—Å—Ç—ã –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è
    available_posts = service_point.service_posts.active.select do |post|
      post_available_at_time?(post, date, start_time, required_duration)
    end
    
    {
      available: available_posts.any?,
      available_posts: available_posts.map(&:post_number),
      recommended_post: find_best_post_for_services(available_posts, services),
      conflicts: find_conflicts_for_time(service_point, date, start_time, required_duration)
    }
  end
  
  # –†–∞—Å—á–µ—Ç –≤—Ä–µ–º–µ–Ω–∏ —Å —É—á–µ—Ç–æ–º –ø–æ—Å—Ç–∞
  def self.calculate_booking_duration(service_ids, post_number = nil)
    services_duration = Service.where(id: service_ids).sum(:base_duration)
    
    if post_number
      post = ServicePost.find_by(post_number: post_number)
      post_slot_duration = post&.slot_duration || 60
      
      # –í—Ä–µ–º—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–µ–≤—ã—à–∞—Ç—å –≤—Ä–µ–º—è —Å–ª–æ—Ç–∞ –ø–æ—Å—Ç–∞
      [services_duration, post_slot_duration].min
    else
      services_duration
    end
  end
  
  # –ü–æ–∏—Å–∫ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ –ø–æ—Å—Ç–∞ –¥–ª—è —É—Å–ª—É–≥
  def self.find_optimal_post(service_point_id, date, services, preferred_time = nil)
    service_point = ServicePoint.find(service_point_id)
    required_duration = calculate_total_duration(services)
    
    # –ù–∞–π—Ç–∏ –ø–æ—Å—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –≤—ã–ø–æ–ª–Ω–∏—Ç—å —É—Å–ª—É–≥–∏
    suitable_posts = service_point.service_posts.active.select do |post|
      post.slot_duration >= required_duration
    end
    
    # –ù–∞–π—Ç–∏ –Ω–∞–∏–±–æ–ª–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ—Å—Ç–∞
    recommendations = suitable_posts.map do |post|
      optimal_time = find_next_available_time_for_post(post, date, preferred_time)
      efficiency = calculate_post_efficiency(post, required_duration)
      
      {
        post_number: post.post_number,
        post_name: post.name,
        optimal_time: optimal_time,
        efficiency: efficiency,
        waste_time: post.slot_duration - required_duration
      }
    end
    
    # –°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (–º–µ–Ω—å—à–µ –ø—Ä–æ—Å—Ç–æ—è)
    recommendations.sort_by { |r| r[:waste_time] }
  end
  
  private
  
  def self.post_available_at_time?(post, date, start_time, duration)
    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —Å–≤–æ–±–æ–¥–µ–Ω –ª–∏ –ø–æ—Å—Ç –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è
    end_time = start_time + duration.minutes
    
    !ScheduleSlot.joins(:bookings)
      .where(
        slot_date: date,
        post_number: post.post_number
      )
      .where('start_time < ? AND end_time > ?', end_time, start_time)
      .exists?
  end
  
  def self.find_best_post_for_services(available_posts, services)
    required_duration = calculate_total_duration(services)
    
    # –í—ã–±—Ä–∞—Ç—å –ø–æ—Å—Ç —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º –ø—Ä–æ—Å—Ç–æ–µ–º
    available_posts.min_by do |post|
      post.slot_duration - required_duration
    end
  end
end
```

### 3. –ú–æ–¥–µ–ª—å Service - –¥–æ–±–∞–≤–∏—Ç—å –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

```ruby
# –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—è –≤ –º–∏–≥—Ä–∞—Ü–∏—é:
# - base_duration: integer (–±–∞–∑–æ–≤–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤ –º–∏–Ω—É—Ç–∞—Ö)
# - duration_multiplier_by_car_type: jsonb (–º–Ω–æ–∂–∏—Ç–µ–ª–∏ –ø–æ —Ç–∏–ø–∞–º –∞–≤—Ç–æ)

# –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥—ã:
def duration_for_car_type(car_type)
  base_duration * (duration_multiplier_by_car_type[car_type.to_s] || 1.0)
end

def adjusted_duration(car_type = nil)
  car_type ? duration_for_car_type(car_type) : base_duration
end

# –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å –ø–æ—Å—Ç–∞–º–∏
def fits_in_post?(service_post, car_type = nil)
  adjusted_duration(car_type) <= service_post.slot_duration
end
```

### 4. API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–æ–∫ (–æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ)

```
POST /api/v1/bookings/check_availability
  # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: service_point_id, date, start_time, service_ids, car_type_id, preferred_post
  # –û—Ç–≤–µ—Ç: 
  {
    available: true/false, 
    available_posts: [1, 3], 
    recommended_post: 1,
    post_details: [
      {post_number: 1, available: true, efficiency: 95%, waste_time: 5},
      {post_number: 2, available: false, next_available: "10:40"},
      {post_number: 3, available: true, efficiency: 80%, waste_time: 10}
    ],
    conflicts: [], 
    suggested_times: []
  }

POST /api/v1/bookings/calculate_duration
  # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: service_ids, car_type_id, post_number
  # –û—Ç–≤–µ—Ç: 
  {
    total_duration: 35, 
    services_duration: 35,
    post_slot_duration: 40,
    efficiency: 87.5,
    waste_time: 5,
    service_durations: [
      {service_id: 1, name: "–ó–∞–º–µ–Ω–∞ –∫–æ–ª–µ—Å", duration: 20},
      {service_id: 2, name: "–ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞", duration: 15}
    ]
  }

GET /api/v1/bookings/optimal_posts
  # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: service_point_id, date, service_ids, preferred_time, car_type_id
  # –û—Ç–≤–µ—Ç: 
  {
    recommendations: [
      {
        post_number: 1,
        post_name: "–ü–æ—Å—Ç –±—ã—Å—Ç—Ä–æ–≥–æ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è",
        optimal_time: "10:00",
        efficiency: 95%,
        waste_time: 5,
        next_available: "10:00"
      }
    ],
    alternative_times: ["10:30", "11:00", "11:30"]
  }

GET /api/v1/service_points/:id/posts/:post_number/availability/:date
  # –û—Ç–≤–µ—Ç: —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ—Å—Ç–∞
```

### 5. –£–ª—É—á—à–µ–Ω–∏—è –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π

```ruby
# –í BookingsController –¥–æ–±–∞–≤–∏—Ç—å:
before_action :check_slot_availability_for_post, only: [:create]
before_action :calculate_duration_for_post, only: [:create]
before_action :find_optimal_post, only: [:create]

private

def check_slot_availability_for_post
  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ—Å—Ç–∞
  unless BookingManager.check_availability(
    booking_params[:service_point_id],
    booking_params[:appointment_date],
    booking_params[:appointment_time],
    booking_params[:service_ids],
    booking_params[:post_number]
  )[:available]
    render json: { errors: ['–í—ã–±—Ä–∞–Ω–Ω—ã–π –ø–æ—Å—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è'] }, status: :unprocessable_entity
  end
end

def calculate_duration_for_post
  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç –≤—Ä–µ–º–µ–Ω–∏ —Å —É—á–µ—Ç–æ–º –ø–æ—Å—Ç–∞
  duration = BookingManager.calculate_booking_duration(
    booking_params[:service_ids],
    booking_params[:post_number]
  )
  
  @calculated_end_time = Time.parse(booking_params[:appointment_time]) + duration.minutes
end

def find_optimal_post
  # –ï—Å–ª–∏ –ø–æ—Å—Ç –Ω–µ —É–∫–∞–∑–∞–Ω, –Ω–∞–π—Ç–∏ –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π
  unless booking_params[:post_number]
    optimal = BookingManager.find_optimal_post(
      booking_params[:service_point_id],
      booking_params[:appointment_date],
      Service.where(id: booking_params[:service_ids]),
      booking_params[:appointment_time]
    ).first
    
    params[:booking][:post_number] = optimal[:post_number] if optimal
  end
end

def booking_params
  params.require(:booking).permit(
    :service_point_id, :client_id, :appointment_date, :appointment_time,
    :post_number, :car_brand, :car_model, :car_year, :notes,
    service_ids: []
  )
end
```

## üìä –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–æ—Å—Ç—å –∑–∞–¥–∞—á

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 0 (–ë–õ–û–ö–ï–† - –∑–∞–≤–∏—Å–∏—Ç –æ—Ç ServicePost):
1. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–π Booking** - —É—á–µ—Ç –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤
2. **BookingManager.check_availability** - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å —É—á–µ—Ç–æ–º –ø–æ—Å—Ç–æ–≤
3. **–†–∞—Å—á–µ—Ç –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –ø–æ—Å—Ç–æ–≤** - calculate_duration_for_post
4. **API –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏** - –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1 (–∫—Ä–∏—Ç–∏—á–Ω–æ - –±–ª–æ–∫–µ—Ä—ã MVP):
1. **–†–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ª–æ—Ç–æ–≤ –ø–æ—Å—Ç–æ–≤** - –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –¥–≤–æ–π–Ω—ã—Ö –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π
2. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç –≤—Ä–µ–º–µ–Ω–∏** - –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
3. **–í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –ø–æ—Å—Ç–æ–≤** - –∑–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–π
4. **–ü–æ–∏—Å–∫ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ –ø–æ—Å—Ç–∞** - —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2 (–≤–∞–∂–Ω–æ –¥–ª—è –∫–∞—á–µ—Å—Ç–≤–∞):
1. –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤ –∏ –≤—Ä–µ–º–µ–Ω–∏
2. –ì—Ä—É–ø–ø–æ–≤–æ–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ª—É–≥ –Ω–∞ –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã—Ö –ø–æ—Å—Ç–∞—Ö
3. –í–∞–ª–∏–¥–∞—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π —Å —É—á–µ—Ç–æ–º –ø–æ—Å—Ç–æ–≤
4. –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–æ—Å—Ç–æ–≤

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3 (—É–ª—É—á—à–µ–Ω–∏—è UX):
1. –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ—Å—Ç–æ–≤ –∏ –≤—Ä–µ–º–µ–Ω–∏
2. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞—Ö  
3. –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ–º –ø–æ—Å—Ç–æ–≤
4. –ì–∏–±–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —É—Å–ª—É–≥ –ø–æ –ø–æ—Å—Ç–∞–º

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏)

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
1. **–û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –Ω–∞ –æ–¥–∏–Ω –ø–æ—Å—Ç** - race conditions
2. **–ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ —Å–ª–æ—Ç–∞ –ø–æ—Å—Ç–∞** - –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
3. **–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –ø–æ—Å—Ç —Å –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º–æ–π –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é** - –≤–∞–ª–∏–¥–∞—Ü–∏—è —É—Å–ª—É–≥
4. **–ò–∑–º–µ–Ω–µ–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞–º–∏ –ø–æ—Å—Ç–æ–≤** - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
5. **–ú–∞—Å—Å–æ–≤–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –Ω–∞ —Ä–∞–∑–Ω—ã—Ö –ø–æ—Å—Ç–∞—Ö** - –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
6. **–ü–æ–∏—Å–∫ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ –ø–æ—Å—Ç–∞ –¥–ª—è –∫–æ–º–ø–ª–µ–∫—Å–∞ —É—Å–ª—É–≥** - –∞–ª–≥–æ—Ä–∏—Ç–º –≤—ã–±–æ—Ä–∞
7. **–†–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ —Å–ª–æ—Ç–æ–≤ –ø–æ—Å—Ç–æ–≤** - lifecycle

### –¢–µ—Å—Ç—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:
1. –í—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ø–æ—Å—Ç–æ–≤
2. –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –ø–æ—Å—Ç–æ–≤ –∏ —Å–ª–æ—Ç–æ–≤
3. –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–∏–∫–æ–≤—ã—Ö –Ω–∞–≥—Ä—É–∑–æ–∫ –Ω–∞ —Ä–∞–∑–Ω—ã–µ –ø–æ—Å—Ç—ã
4. –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –Ω–∞ –æ–¥–Ω–æ–º –ø–æ—Å—Ç—É
5. –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∞–ª–≥–æ—Ä–∏—Ç–º–∞ –ø–æ–∏—Å–∫–∞ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ –ø–æ—Å—Ç–∞

### –ù–æ–≤—ã–µ edge cases:
1. –í—Å–µ –ø–æ—Å—Ç—ã –∑–∞–Ω—è—Ç—ã, –Ω–æ —Å —Ä–∞–∑–Ω—ã–º –≤—Ä–µ–º–µ–Ω–µ–º –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è
2. –£—Å–ª—É–≥–∏ –Ω–µ –ø–æ–º–µ—â–∞—é—Ç—Å—è –Ω–∏ –≤ –æ–¥–∏–Ω –ø–æ—Å—Ç
3. –ò–∑–º–µ–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ—Å—Ç–∞ –≤–æ –≤—Ä–µ–º—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π
4. –î–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ—Å—Ç–∞ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è–º–∏ 