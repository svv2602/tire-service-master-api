# API Пользователей

## Обзор

API пользователей предоставляет функциональность для управления пользователями системы. Включает в себя операции создания, чтения, обновления и деактивации пользователей (CRUD), а также поиск и фильтрацию.

## Роли пользователей

Система поддерживает следующие роли:

- **admin** - Администратор с полными правами доступа
- **manager** - Менеджер сервисной точки
- **partner** - Партнер, владелец сервисных точек
- **client** - Клиент, использующий услуги

## Авторизация

Все эндпоинты требуют JWT токен в заголовке Authorization:
```
Authorization: Bearer <jwt_token>
```

## Эндпоинты

### GET /api/v1/users/me

Получает информацию о текущем авторизованном пользователе.

**Доступ:** Все авторизованные пользователи

**Ответ:**
```json
{
  "data": {
    "id": 1,
    "email": "user@example.com",
    "phone": "+380991234567",
    "first_name": "Иван",
    "last_name": "Петров",
    "middle_name": "Сидорович",
    "role": {
      "id": 1,
      "name": "admin",
      "description": "Administrator role"
    },
    "is_active": true,
    "email_verified": true,
    "phone_verified": false,
    "last_login": "2024-01-15T10:30:00Z",
    "created_at": "2024-01-01T00:00:00Z",
    "updated_at": "2024-01-15T10:30:00Z"
  }
}
```

### GET /api/v1/users

Получает список всех пользователей с пагинацией, поиском и фильтрацией.

**Доступ:** Только администраторы

**Параметры запроса:**
- `page` (integer, optional) - Номер страницы (по умолчанию: 1)
- `per_page` (integer, optional) - Количество элементов на странице (по умолчанию: 25, максимум: 100)
- `query` (string, optional) - Поиск по email, имени или фамилии
- `active` (string, optional) - Фильтр по активности ('true' или 'false')

**Пример запроса:**
```
GET /api/v1/users?page=1&per_page=10&query=иван&active=true
```

**Ответ:**
```json
{
  "data": [
    {
      "id": 1,
      "email": "ivan@example.com",
      "phone": "+380991234567",
      "first_name": "Иван",
      "last_name": "Петров",
      "middle_name": "Сидорович",
      "role": {
        "id": 1,
        "name": "admin",
        "description": "Administrator role"
      },
      "is_active": true,
      "email_verified": true,
      "phone_verified": false,
      "last_login": "2024-01-15T10:30:00Z",
      "created_at": "2024-01-01T00:00:00Z",
      "updated_at": "2024-01-15T10:30:00Z"
    }
  ],
  "pagination": {
    "current_page": 1,
    "total_pages": 5,
    "total_count": 42,
    "per_page": 10
  }
}
```

### GET /api/v1/users/{id}

Получает информацию о конкретном пользователе.

**Доступ:** 
- Администраторы могут просматривать любого пользователя
- Обычные пользователи могут просматривать только свой профиль

**Параметры:**
- `id` (integer) - ID пользователя

**Ответ:** Аналогичен GET /api/v1/users/me

### POST /api/v1/users

Создает нового пользователя.

**Доступ:** Только администраторы

**Тело запроса:**
```json
{
  "user": {
    "email": "newuser@example.com",
    "phone": "+380991234567",
    "first_name": "Новый",
    "last_name": "Пользователь",
    "middle_name": "Отчество",
    "password": "password123",
    "password_confirmation": "password123",
    "role_id": 4
  }
}
```

**Обязательные поля:**
- `email` - Уникальный email пользователя
- `first_name` - Имя (минимум 2 символа)
- `last_name` - Фамилия (минимум 2 символа)
- `password` - Пароль (минимум 6 символов)
- `password_confirmation` - Подтверждение пароля
- `role_id` - ID роли пользователя

**Ответ:**
```json
{
  "data": {
    // ... данные созданного пользователя
  },
  "message": "User created successfully"
}
```

### PUT /api/v1/users/{id}

Обновляет информацию о пользователе.

**Доступ:**
- Администраторы могут обновлять любого пользователя
- Обычные пользователи могут обновлять только свой профиль

**Параметры:**
- `id` (integer) - ID пользователя

**Тело запроса:**
```json
{
  "user": {
    "email": "updated@example.com",
    "phone": "+380991234567",
    "first_name": "Обновленное",
    "last_name": "Имя",
    "middle_name": "Отчество",
    "role_id": 4,
    "is_active": true
  }
}
```

**Ответ:**
```json
{
  "data": {
    // ... обновленные данные пользователя
  },
  "message": "User updated successfully"
}
```

### DELETE /api/v1/users/{id}

Деактивирует пользователя (soft delete). Пользователь не удаляется физически, а помечается как неактивный.

**Доступ:** Только администраторы

**Ограничения:**
- Администратор не может деактивировать самого себя

**Параметры:**
- `id` (integer) - ID пользователя

**Ответ:**
```json
{
  "message": "User deactivated successfully"
}
```

## Коды ошибок

- **200** - Успешный запрос
- **201** - Ресурс создан
- **401** - Не авторизован (отсутствует или недействительный токен)
- **403** - Недостаточно прав доступа
- **404** - Пользователь не найден
- **422** - Ошибка валидации

## Примеры ошибок

### Ошибка валидации (422)
```json
{
  "errors": {
    "email": ["has already been taken"],
    "password": ["is too short (minimum is 6 characters)"]
  }
}
```

### Ошибка доступа (403)
```json
{
  "error": "Access denied",
  "details": {
    "message": "You don't have permission to perform this action"
  }
}
```

### Пользователь не найден (404)
```json
{
  "error": "User not found",
  "details": {
    "message": "User with ID 999 does not exist"
  }
}
```

## Особенности реализации

### Soft Delete
Система использует "мягкое удаление" - пользователи не удаляются физически из базы данных, а помечаются как неактивные (`is_active: false`). Это позволяет:
- Сохранить историю действий пользователя
- Восстановить пользователя при необходимости
- Избежать нарушения целостности данных

### Поиск
Поиск работает по следующим полям:
- Email (без учета регистра)
- Имя (без учета регистра)
- Фамилия (без учета регистра)

### Нормализация данных
- Email автоматически приводится к нижнему регистру
- Телефон нормализуется (удаляются все символы кроме цифр и знака +)

### Валидация
- Email должен быть уникальным и соответствовать формату email
- Телефон должен содержать от 10 до 15 цифр (может начинаться с +)
- Пароль должен содержать минимум 6 символов
- Имя и фамилия должны содержать минимум 2 символа

### Роли и права доступа
Система использует Pundit для управления правами доступа:
- **Администраторы** имеют полный доступ ко всем операциям
- **Менеджеры, партнеры, клиенты** могут просматривать и редактировать только свой профиль
- Список пользователей доступен только администраторам

### Логирование
Все операции с пользователями логируются в системный журнал (`SystemLog`) для аудита и отслеживания изменений. 