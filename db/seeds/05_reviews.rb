# db/seeds/05_reviews.rb
# –°–æ–∑–¥–∞–Ω–∏–µ –æ—Ç–∑—ã–≤–æ–≤ –¥–ª—è —Å–µ—Ä–≤–∏—Å–Ω—ã—Ö —Ç–æ—á–µ–∫

puts '=== –°–æ–∑–¥–∞–Ω–∏–µ –æ—Ç–∑—ã–≤–æ–≤ –¥–ª—è —Å–µ—Ä–≤–∏—Å–Ω—ã—Ö —Ç–æ—á–µ–∫ ==='

# –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ
service_points = ServicePoint.all
clients = Client.all

if service_points.empty?
  puts "‚ùå –ù–µ—Ç —Å–µ—Ä–≤–∏—Å–Ω—ã—Ö —Ç–æ—á–µ–∫ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ—Ç–∑—ã–≤–æ–≤"
  exit
end

if clients.empty?
  puts "‚ùå –ù–µ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ç–∑—ã–≤–æ–≤"
  exit
end

# –®–∞–±–ª–æ–Ω—ã –æ—Ç–∑—ã–≤–æ–≤
positive_reviews = [
  {
    rating: 5,
    comment: "–í—ñ–¥–º—ñ–Ω–Ω–∏–π —Å–µ—Ä–≤—ñ—Å! –®–≤–∏–¥–∫–æ —ñ —è–∫—ñ—Å–Ω–æ –ø–æ–º—ñ–Ω—è–ª–∏ —à–∏–Ω–∏. –ü–µ—Ä—Å–æ–Ω–∞–ª –¥—É–∂–µ –≤–≤—ñ—á–ª–∏–≤–∏–π —Ç–∞ –ø—Ä–æ—Ñ–µ—Å—ñ–π–Ω–∏–π. –û–±–æ–≤'—è–∑–∫–æ–≤–æ –ø–æ–≤–µ—Ä–Ω—É—Å—è —â–µ —Ä–∞–∑!",
    pros: "–®–≤–∏–¥–∫—ñ—Å—Ç—å –æ–±—Å–ª—É–≥–æ–≤—É–≤–∞–Ω–Ω—è, –ø—Ä–æ—Ñ–µ—Å—ñ–æ–Ω–∞–ª—ñ–∑–º, —á–∏—Å—Ç–æ—Ç–∞",
    cons: nil
  },
  {
    rating: 5,
    comment: "–î—É–∂–µ –∑–∞–¥–æ–≤–æ–ª–µ–Ω–∏–π –æ–±—Å–ª—É–≥–æ–≤—É–≤–∞–Ω–Ω—è–º! –ó—Ä–æ–±–∏–ª–∏ –±–∞–ª–∞–Ω—Å—É–≤–∞–Ω–Ω—è –∫–æ–ª—ñ—Å —à–≤–∏–¥–∫–æ —Ç–∞ —è–∫—ñ—Å–Ω–æ. –¶—ñ–Ω–∏ –∞–¥–µ–∫–≤–∞—Ç–Ω—ñ, –ø–µ—Ä—Å–æ–Ω–∞–ª –∑–Ω–∞—î —Å–≤–æ—é —Å–ø—Ä–∞–≤—É.",
    pros: "–Ø–∫—ñ—Å—Ç—å —Ä–æ–±–æ—Ç–∏, —à–≤–∏–¥–∫—ñ—Å—Ç—å, —Ü—ñ–Ω–∞",
    cons: nil
  },
  {
    rating: 4,
    comment: "–•–æ—Ä–æ—à–∏–π —à–∏–Ω–æ–º–æ–Ω—Ç–∞–∂. –®–≤–∏–¥–∫–æ –≤–∏–∫–æ–Ω–∞–ª–∏ –∑–∞–º—ñ–Ω—É —à–∏–Ω, –≤—Å–µ –∞–∫—É—Ä–∞—Ç–Ω–æ. –Ñ–¥–∏–Ω–∏–π –º—ñ–Ω—É—Å - –¥–æ–≤–µ–ª–æ—Å—è —Ç—Ä–æ—Ö–∏ –ø–æ—á–µ–∫–∞—Ç–∏ –≤ —á–µ—Ä–∑—ñ.",
    pros: "–Ø–∫—ñ—Å—Ç—å —Ä–æ–±–æ—Ç–∏, –∞–∫—É—Ä–∞—Ç–Ω—ñ—Å—Ç—å",
    cons: "–ù–µ–≤–µ–ª–∏–∫–∞ —á–µ—Ä–≥–∞"
  },
  {
    rating: 5,
    comment: "–†–µ–∫–æ–º–µ–Ω–¥—É—é! –ü—Ä–æ—Ñ–µ—Å—ñ–π–Ω—ñ –º–∞–π—Å—Ç—Ä–∏, —Å—É—á–∞—Å–Ω–µ –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è. –ó—Ä–æ–±–∏–ª–∏ –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫—É —Ö–æ–¥–æ–≤–æ—ó —á–∞—Å—Ç–∏–Ω–∏ - –≤–∏—è–≤–∏–ª–∏ –ø—Ä–æ–±–ª–µ–º–∏, —è–∫—ñ –Ω–µ –ø–æ–º—ñ—á–∞–ª–∏ –≤ —ñ–Ω—à–∏—Ö –°–¢–û.",
    pros: "–ü—Ä–æ—Ñ–µ—Å—ñ–æ–Ω–∞–ª—ñ–∑–º, —Å—É—á–∞—Å–Ω–µ –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è, –¥–µ—Ç–∞–ª—å–Ω–∞ –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞",
    cons: nil
  },
  {
    rating: 4,
    comment: "–ì–∞—Ä–Ω–∏–π —Å–µ—Ä–≤—ñ—Å, —à–≤–∏–¥–∫–æ –ø–æ–º—ñ–Ω—è–ª–∏ –º–∞—Å–ª–æ —Ç–∞ —Ñ—ñ–ª—å—Ç—Ä–∏. –ü–µ—Ä—Å–æ–Ω–∞–ª –ø–æ—è—Å–Ω–∏–≤ —â–æ —ñ –Ω–∞–≤—ñ—â–æ —Ä–æ–±–∏—Ç—å. –¶—ñ–Ω–∏ –Ω–æ—Ä–º–∞–ª—å–Ω—ñ.",
    pros: "–®–≤–∏–¥–∫—ñ—Å—Ç—å, –ø–æ—è—Å–Ω–µ–Ω–Ω—è —Ä–æ–±–æ—Ç–∏, –∞–¥–µ–∫–≤–∞—Ç–Ω—ñ —Ü—ñ–Ω–∏",
    cons: nil
  }
]

neutral_reviews = [
  {
    rating: 3,
    comment: "–û–±—Å–ª—É–≥–æ–≤—É–≤–∞–Ω–Ω—è –Ω–æ—Ä–º–∞–ª—å–Ω–µ, –∞–ª–µ –Ω—ñ—á–æ–≥–æ –æ—Å–æ–±–ª–∏–≤–æ–≥–æ. –ó—Ä–æ–±–∏–ª–∏ —â–æ —Ç—Ä–µ–±–∞, –∞–ª–µ –±–µ–∑ –æ—Å–æ–±–ª–∏–≤–æ–≥–æ –µ–Ω—Ç—É–∑—ñ–∞–∑–º—É.",
    pros: "–í–∏–∫–æ–Ω–∞–ª–∏ —Ä–æ–±–æ—Ç—É",
    cons: "–ù–µ –¥—É–∂–µ –¥—Ä—É–∂–µ–ª—é–±–Ω–∏–π –ø–µ—Ä—Å–æ–Ω–∞–ª"
  },
  {
    rating: 3,
    comment: "–°–µ—Ä–µ–¥–Ω—ñ–π —Ä—ñ–≤–µ–Ω—å —Å–µ—Ä–≤—ñ—Å—É. –†–æ–±–æ—Ç—É –≤–∏–∫–æ–Ω–∞–ª–∏, –∞–ª–µ —Ü—ñ–Ω–∏ —Ç—Ä–æ—Ö–∏ –∑–∞–≤–∏—â–µ–Ω—ñ. –ú–æ–∂–Ω–∞ –∑–Ω–∞–π—Ç–∏ –¥–µ—à–µ–≤—à–µ –≤ —ñ–Ω—à–∏—Ö –º—ñ—Å—Ü—è—Ö.",
    pros: "–í–∏–∫–æ–Ω–∞–ª–∏ —Ä–æ–±–æ—Ç—É –≤—á–∞—Å–Ω–æ",
    cons: "–ó–∞–≤–∏—â–µ–Ω—ñ —Ü—ñ–Ω–∏"
  }
]

negative_reviews = [
  {
    rating: 2,
    comment: "–ù–µ –¥—É–∂–µ –∑–∞–¥–æ–≤–æ–ª–µ–Ω–∏–π. –î–æ–≤–≥–æ —á–µ–∫–∞–≤, –∞ –ø–æ—Ç—ñ–º —â–µ –π –∑–Ω–∞–π—à–ª–∏ –ø–æ–¥—Ä—è–ø–∏–Ω—É –Ω–∞ –¥–∏—Å–∫—É, —è–∫–æ—ó —Ä–∞–Ω—ñ—à–µ –Ω–µ –±—É–ª–æ.",
    pros: nil,
    cons: "–î–æ–≤–≥–µ –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è, –ø–æ—à–∫–æ–¥–∂–µ–Ω–Ω—è –¥–∏—Å–∫–∞"
  }
]

# –í—Å—ñ —à–∞–±–ª–æ–Ω–∏ —Ä–∞–∑–æ–º
all_reviews = positive_reviews + neutral_reviews + negative_reviews

created_count = 0
updated_count = 0

service_points.each do |service_point|
  puts "  üí¨ –°–æ–∑–¥–∞–Ω–∏–µ –æ—Ç–∑—ã–≤–æ–≤ –¥–ª—è: #{service_point.name}"
  
  # –°–æ–∑–¥–∞–µ–º 3-6 –æ—Ç–∑—ã–≤–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–π —Ç–æ—á–∫–∏
  reviews_count = rand(3..6)
  
  reviews_count.times do |index|
    # –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
    client = clients.sample
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –æ—Å—Ç–∞–≤–ª—è–ª –ª–∏ —É–∂–µ —ç—Ç–æ—Ç –∫–ª–∏–µ–Ω—Ç –æ—Ç–∑—ã–≤ –¥–ª—è —ç—Ç–æ–π —Ç–æ—á–∫–∏
    existing_review = Review.find_by(
      service_point: service_point,
      client: client
    )
    
    if existing_review
      # –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –æ—Ç–∑—ã–≤
      review_template = all_reviews.sample
      existing_review.update!(
        rating: review_template[:rating],
        comment: review_template[:comment],
        is_published: true
      )
      updated_count += 1
      puts "    ‚úèÔ∏è  –û–±–Ω–æ–≤–ª–µ–Ω –æ—Ç–∑—ã–≤ –æ—Ç: #{client.id} (#{review_template[:rating]}‚≠ê)"
    else
      # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –æ—Ç–∑—ã–≤
      review_template = all_reviews.sample
      
      Review.create!(
        service_point: service_point,
        client: client,
        rating: review_template[:rating],
        comment: review_template[:comment],
        is_published: true,
        created_at: rand(30.days.ago..Time.current)
      )
      created_count += 1
      puts "    ‚ú® –°–æ–∑–¥–∞–Ω –æ—Ç–∑—ã–≤ –æ—Ç: #{client.id} (#{review_template[:rating]}‚≠ê)"
    end
  end
end

puts ""
puts "üìä –†–µ–∑—É–ª—å—Ç–∞—Ç:"
puts "  –°–æ–∑–¥–∞–Ω–æ –Ω–æ–≤—ã—Ö –æ—Ç–∑—ã–≤–æ–≤: #{created_count}"
puts "  –û–±–Ω–æ–≤–ª–µ–Ω–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –æ—Ç–∑—ã–≤–æ–≤: #{updated_count}"
puts "  –í—Å–µ–≥–æ –æ—Ç–∑—ã–≤–æ–≤ –≤ —Å–∏—Å—Ç–µ–º–µ: #{Review.count}"

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ä–µ–π—Ç–∏–Ω–≥–∞–º
puts ""
puts "üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—Ç–∑—ã–≤–æ–≤ –ø–æ —Å–µ—Ä–≤–∏—Å–Ω—ã–º —Ç–æ—á–∫–∞–º:"
ServicePoint.includes(:reviews).each do |sp|
  reviews = sp.reviews
  if reviews.any?
    avg_rating = reviews.average(:rating).round(1)
    rating_counts = reviews.group(:rating).count
    puts "  #{sp.name}: #{reviews.count} –æ—Ç–∑—ã–≤–æ–≤, —Å—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥: #{avg_rating}‚≠ê"
    rating_counts.each { |rating, count| puts "    #{rating}‚≠ê: #{count} –æ—Ç–∑—ã–≤–æ–≤" }
  else
    puts "  #{sp.name}: –Ω–µ—Ç –æ—Ç–∑—ã–≤–æ–≤"
  end
end

puts ""
puts "‚úÖ –û—Ç–∑—ã–≤—ã –¥–ª—è —Å–µ—Ä–≤–∏—Å–Ω—ã—Ö —Ç–æ—á–µ–∫ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω—ã/–æ–±–Ω–æ–≤–ª–µ–Ω—ã!" 